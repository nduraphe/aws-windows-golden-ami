name: Build Windows Golden AMI

on:
  workflow_dispatch:
    inputs:
      server_type:
        description: "Select Windows server type or choose custom"
        required: true
        type: choice
        options:
          - member_server
          - domain_controller
          - custom

      custom_name:
        description: "Custom server type (if server_type=custom)"
        required: false
        default: ""

      custom_bucket:
        description: "Custom S3 bucket for software/scripts (if server_type=custom)"
        required: false
        default: ""

      custom_script:
        description: "Custom script path under the S3 bucket (if server_type=custom)"
        required: false
        default: ""

      share_account_ids:
        description: "Comma-separated AWS account IDs to share AMI with (optional)"
        required: false
        default: ""

jobs:
  build-ami:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      DEFAULT_BUCKET: golden-ami-softwares-nagesh

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Latest Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "latest"

      - name: Prepare Build Variables
        id: vars
        run: |
          # Selected server type
          TYPE="${{ github.event.inputs.server_type }}"

          # Convert comma-separated share_account_ids â†’ HCL list
          RAW_ACCOUNTS="${{ github.event.inputs.share_account_ids }}"

          if [ -z "$RAW_ACCOUNTS" ]; then
            SHARE="[]"
          else
            RAW_CLEAN=$(echo "$RAW_ACCOUNTS" | tr -d ' ')
            IFS=',' read -r -a ARR <<< "$RAW_CLEAN"

            SHARE="["

            for i in "${!ARR[@]}"; do
              ID="${ARR[$i]}"

              # Validate AWS account ID (must be 12 digits)
              if ! [[ "$ID" =~ ^[0-9]{12}$ ]]; then
                echo "âŒ Invalid AWS account ID: $ID"
                echo "All account IDs must be 12-digit numeric."
                exit 1
              fi

              [[ $i -gt 0 ]] && SHARE+=", "
              SHARE+="\"$ID\""
            done

            SHARE+="]"
          fi

          echo "share_account_ids=$SHARE" >> $GITHUB_OUTPUT

          # Custom Server Handling
          if [ "$TYPE" = "custom" ]; then

            MISSING=""

            # Check custom_name
            if [ -z "${{ github.event.inputs.custom_name }}" ]; then
              MISSING="${MISSING}custom_name "
            fi

            # Check custom_bucket
            if [ -z "${{ github.event.inputs.custom_bucket }}" ]; then
              MISSING="${MISSING}custom_bucket "
            fi

            # Check custom_script
            if [ -z "${{ github.event.inputs.custom_script }}" ]; then
              MISSING="${MISSING}custom_script "
            fi

            # If anything missing â†’ fail with clear message
            if [ -n "$MISSING" ]; then
              echo "âŒ ERROR: Missing required custom fields: ${MISSING// /, }"
              echo "Required when server_type=custom:"
              echo "  â€¢ custom_name"
              echo "  â€¢ custom_bucket"
              echo "  â€¢ custom_script"
              exit 1
            fi

            # Cleanup + normalize custom_name
            CUSTOM_NAME_CLEAN=$(echo "${{ github.event.inputs.custom_name }}" | xargs | tr '[:upper:]' '[:lower:]')

            # Validate format
            if ! [[ "$CUSTOM_NAME_CLEAN" =~ ^[a-z0-9_-]+$ ]]; then
              echo "âŒ ERROR: custom_name contains invalid characters!"
              echo "Allowed: letters, numbers, hyphen, underscore"
              exit 1
            fi

            echo "server_type=$CUSTOM_NAME_CLEAN" >> $GITHUB_OUTPUT
            echo "software_bucket=${{ github.event.inputs.custom_bucket }}" >> $GITHUB_OUTPUT
            echo "manual_script_key=${{ github.event.inputs.custom_script }}" >> $GITHUB_OUTPUT

          else
            echo "server_type=$TYPE" >> $GITHUB_OUTPUT
            echo "software_bucket=${{ env.DEFAULT_BUCKET }}" >> $GITHUB_OUTPUT
            echo "manual_script_key=" >> $GITHUB_OUTPUT
          fi

      - name: Resolving final software install script key
        id: finalscript 
        run: |
          echo ""

          if [ "${{ steps.vars.outputs.manual_script_key }}" != "" ]; then
            FINAL_SCRIPT="${{ steps.vars.outputs.manual_script_key }}"
          else
            case "${{ steps.vars.outputs.server_type }}" in
              member_server)
                FINAL_SCRIPT="windows/scripts/member_server_software_install.ps1"
                ;;
              domain_controller)
                FINAL_SCRIPT="windows/scripts/domain_controller_software_install.ps1"
                ;;
              *)
                echo "âŒ ERROR: Unknown server_type: ${{ steps.vars.outputs.server_type }}"
                echo "Valid types: member_server, domain_controller, or custom"
                exit 1
                ;;
            esac
          fi

          echo "install_script=$FINAL_SCRIPT" >> $GITHUB_OUTPUT
          echo "============================================"
          echo ""

      - name: Print Final Build Variables
        run: |
          echo ""
          echo "============================================"
          echo "           FINAL BUILD VARIABLES"
          echo "============================================"

          printf "| %-20s | %-55s |\n" "VARIABLE" "VALUE"
          printf "|----------------------|---------------------------------------------------------|\n"
          printf "| %-20s | %-55s |\n" "AWS_REGION" "${{ env.AWS_REGION }}"
          printf "| %-20s | %-55s |\n" "SERVER_TYPE" "${{ steps.vars.outputs.server_type }}"
          printf "| %-20s | %-55s |\n" "SOFTWARE_BUCKET" "${{ steps.vars.outputs.software_bucket }}"
          printf "| %-20s | %-55s |\n" "INSTALL_SCRIPT" "${{ steps.finalscript.outputs.install_script }}"
          printf "| %-20s | %-55s |\n" "SHARE_ACCOUNT_IDS" "${{ steps.vars.outputs.share_account_ids }}"

          echo "============================================"
          echo ""

      - name: Packer Init
        working-directory: packer
        run: packer init windows-golden.pkr.hcl

      - name: List Packer Directory
        run: ls -R .
        working-directory: packer

      - name: Validate Packer Template
        working-directory: packer
        run: |
          packer validate \
            -var "aws_region=${{ env.AWS_REGION }}" \
            -var "server_type=${{ steps.vars.outputs.server_type }}" \
            -var "software_bucket=${{ steps.vars.outputs.software_bucket }}" \
            -var "install_script_key=${{ steps.finalscript.outputs.install_script }}" \
            -var "share_account_ids=${{ steps.vars.outputs.share_account_ids }}" \
            .

      - name: Build Windows Golden AMI
        id: packerbuild
        working-directory: packer
        run: |
          set -e
          AMI_OUTPUT=$(mktemp)

          packer build \
            -machine-readable \
            -var "aws_region=${{ env.AWS_REGION }}" \
            -var "server_type=${{ steps.vars.outputs.server_type }}" \
            -var "software_bucket=${{ steps.vars.outputs.software_bucket }}" \
            -var "install_script_key=${{ steps.finalscript.outputs.install_script }}" \
            -var "share_account_ids=${{ steps.vars.outputs.share_account_ids }}" \
            . | tee "$AMI_OUTPUT"

          AMI_ID=$(awk -F, '/artifact,0,id/ {print $6}' "$AMI_OUTPUT" | sed 's/.*://')

          echo "AMI_ID=$AMI_ID"
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT

      - name: Store AMI ID in SSM Parameter Store
        if: success()
        id: ssmstore
        run: |
          AMI_ID="${{ steps.packerbuild.outputs.ami_id }}"
          SERVER_TYPE="${{ steps.vars.outputs.server_type }}"

          echo "Storing AMI in SSM parameter: /golden-ami/$SERVER_TYPE"
          echo "AMI: $AMI_ID"

          aws ssm put-parameter \
            --name "/golden-ami/$SERVER_TYPE" \
            --type "String" \
            --value "$AMI_ID" \
            --overwrite \
            --region "${{ env.AWS_REGION }}"

          echo "ssm_parameter=/golden-ami/$SERVER_TYPE" >> $GITHUB_OUTPUT

      - name: Publish AMI ID to Summary
        run: |
          echo "### ðŸš€ Golden AMI Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**AMI ID:** \`${{ steps.packerbuild.outputs.ami_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Server Type:** \`${{ steps.vars.outputs.server_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Software Bucket:** \`${{ steps.vars.outputs.software_bucket }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Install Script:** \`${{ steps.finalscript.outputs.install_script }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Stored in SSM:** \`${{ steps.ssmstore.outputs.ssm_parameter }}\`" >> $GITHUB_STEP_SUMMARY

          # Shared Accounts
          if [ "${{ steps.vars.outputs.share_account_ids }}" != "[]" ]; then
            echo "**Shared With Accounts:** \`${{ steps.vars.outputs.share_account_ids }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Shared With Accounts:** _(None)_ " >> $GITHUB_STEP_SUMMARY
          fi